#!/bin/bash
#Will be executed by crontab every 20 min, chef is solo :-(
REPO="https://s3.amazonaws.com/kiputch-solo"
exists() {
  if command -v $1 >/dev/null 2>&1
  then
    return 0
  else
    return 1
  fi
}
#lets get the custom solo.rb file
exists "wget"
if [ "$?" == "0" ];then
  ID=$(wget -q -O- http://169.254.169.254/latest/meta-data/instance-id)
  SOLORB="solorb/solo.rb_${ID}"
  wget -O "/etc/chef/solo.rb" "$REPO/$SOLORB" 2>/tmp/stderr-cron
 else
   exit 3
fi
ROLES="roles/roles.tar.gz"
#lets get the updated roles.tar.gz file
wget -O "/var/chef-solo/roles/roles.tar.gz" "$REPO/$ROLES" 2>/tmp/stderr-cron
cd /var/chef-solo/roles/
tar xvfz roles.tar.gz
#Now we are ready to run solo
/usr/bin/chef-solo -L /var/log/solorun.log
exit 0
